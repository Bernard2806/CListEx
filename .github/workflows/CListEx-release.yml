name: ðŸ—ï¸ Build and Release Static Library

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # ðŸ“¥ Checkout the latest code from the repository
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for commit counting

      # ðŸ”¨ Compile C source file into an object file
      - name: ðŸ”¨ Compile CListEx.c to object file
        run: gcc -c CListEx.c -o CListEx.o

      # ðŸ“š Create a static library archive from the object file
      - name: ðŸ“š Create static library CListEx.a
        run: ar rcs CListEx.a CListEx.o

      # ðŸ“¦ Prepare release directory and package files into a zip archive
      - name: ðŸ“¦ Prepare release files
        run: |
          mkdir -p release
          cp CListEx.h CListEx.a release/
          cd release
          zip -r ../CListEx-library.zip .

      # ðŸ”¢ Get total commit count using git
      - name: ðŸ”¢ Get commit count
        id: commit_count
        run: |
          commits_count=$(git rev-list --count HEAD)
          echo "commits_count=$commits_count" >> $GITHUB_OUTPUT
          echo "ðŸ“Š Total commits: $commits_count"

      # ðŸ·ï¸ Calculate version from commits count
      - name: ðŸ·ï¸ Calculate version from commits count
        id: version_calc
        run: |
          commits=${{ steps.commit_count.outputs.commits_count }}
          if [ "$commits" -ge 1000 ]; then
            version="1.0.0"
          elif [ "$commits" -ge 100 ]; then
            version="0.1.0"
          elif [ "$commits" -ge 10 ]; then
            version="0.0.1"
          else
            version="0.0.0"
          fi
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "ðŸŽ¯ Generated version: v$version (based on $commits commits)"

      # ðŸš€ Create a GitHub release with the dynamically calculated version
      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version_calc.outputs.version }}
          name: ðŸŽ‰ Release v${{ steps.version_calc.outputs.version }}
          body: |
            ðŸ“š **CListEx Static Library Release**
            
            This release contains:
            - ðŸ”§ Compiled static library `CListEx.a`
            - ðŸ“„ Header file `CListEx.h`
            - ðŸ“Š Based on ${{ steps.commit_count.outputs.commits_count }} commits
            
            ## ðŸ“¥ How to use:
            1. Download `CListEx-library.zip`
            2. Extract the files
            3. Link against `CListEx.a` in your C projects
            4. Include `CListEx.h` in your source code
          files: CListEx-library.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
